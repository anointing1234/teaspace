{% extends "base_sections/base/base.html" %} 
{% load static %}
{% block contents %}

<style>
/* Apply consistent styling to all input fields */
.contact-form__input-box input[type="text"],
.contact-form__input-box input[type="email"],
.contact-form__input-box input[type="password"],
.contact-form__input-box input[type="number"],
.contact-form__input-box input[type="tel"],
.contact-form__input-box input[type="url"],
.contact-form__input-box textarea {
  height: 60px;
  width: 100%;
  border: none;
  background-color: var(--jetly-primary);
  padding: 0 30px;
  outline: none;
  font-size: 14px;
  color: var(--jetly-gray);
  display: block;
  font-weight: 400;
  border-radius: 6px;
  transition: all 0.3s ease;
}
</style>

<!-- Page Header Start -->
<section class="page-header">
    <div class="page-header-bg" style="background-image: url({% static 'assets/images/backgrounds/page-header-bg.jpg' %})"></div>
    <div class="container">
        <div class="page-header__inner">
            <h2>Send Password Reset Code</h2>
            <ul class="thm-breadcrumb list-unstyled">
                <li><a href="{% url 'home' %}">Home</a></li>
                <li><span>/</span></li>
                <li>Send Password Reset Code</li>
            </ul>
        </div>
    </div>
</section>
<!-- Page Header End -->

<!-- Password Reset Request Form Start -->
<section class="password-reset-request mt-5 pt-5 mb-5 pb-5">
  <div class="container d-flex justify-content-center">
    <div class="password-reset-request__form-box w-100" style="max-width: 500px;">
      <form id="password-request-form" action="#" method="POST" class="contact-form-validated" novalidate>
        {% csrf_token %}
        <div class="row">
          <div class="col-xl-12">
            <div class="contact-form__input-box">
              <input type="email" name="email" placeholder="Enter your email address" required>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-xl-12 d-flex justify-content-center">
            <div class="contact-form__btn-box">
              <button type="submit" class="thm-btn">Send Recovery Email</button>
            </div>
          </div>
        </div>
      </form>
      <p class="mt-3 text-center">
        <a href="{% url 'login' %}" style="color: var(--primary-color); text-decoration: underline;">Back to login</a>
      </p>
    </div>
  </div>
</section>
<!-- Password Reset Request Form End -->





<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("password-request-form");
  const button = form.querySelector("button[type='submit']");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = form.email.value.trim();

    if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
      Swal.fire({
        title: "Invalid Email",
        text: "Please enter a valid email address.",
        icon: "warning",
        width: "300px",
      });
      return;
    }

    button.disabled = true;

    Swal.fire({
      title: "Sending...",
      text: "Please wait a moment.",
      icon: "info",
      showConfirmButton: false,
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading(),
      width: "300px",
    });

    try {
      const response = await fetch("{% url 'send_recovery_code' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value,
        },
        body: new FormData(form),
        credentials: "include", // ✅ Keep session cookie so recovery_code is stored
      });

      const data = await response.json();

      if (response.ok && data.success) {
        Swal.fire({
          title: "Email Sent!",
          text: data.message,
          icon: "success",
          confirmButtonColor: "#004aad",
          width: "300px",
          timer: 1500,
          showConfirmButton: false,
        }).then(() => {
          // ✅ Redirect to password reset page
          window.location.href = "{% url 'reset_password_view' %}";
        });
        form.reset();
      } else {
        Swal.fire({
          title: "Error",
          text: data.message,
          icon: "error",
          confirmButtonColor: "#d33",
          width: "300px",
        });
        console.error("Server error:", data);
      }
    } catch (error) {
      Swal.fire({
        title: "Network Error",
        text: "Please check your internet connection and try again.",
        icon: "error",
        width: "300px",
      });
      console.error("Network error:", error);
    } finally {
      button.disabled = false;
    }
  });
});
</script>



{% endblock contents %}
